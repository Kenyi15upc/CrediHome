<div class="container-fluid mt-4">
  <div *ngIf="isLoading" class="text-center mt-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Cargando dashboard...</p>
  </div>

  <div *ngIf="!isLoading">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-speedometer2"></i> Dashboard del Asesor Inmobiliario</h2>
      <button class="btn btn-danger" (click)="logout()">
        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
      </button>
    </div>
    <hr>

    <!-- Navegación de Tabs -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'perfil'" (click)="activeTab = 'perfil'" href="javascript:void(0)">
          <i class="bi bi-person-circle"></i> Mi Perfil
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'clientes'" (click)="activeTab = 'clientes'" href="javascript:void(0)">
          <i class="bi bi-people-fill"></i> Clientes
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'unidades'" (click)="activeTab = 'unidades'" href="javascript:void(0)">
          <i class="bi bi-building"></i> Unidades
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'simulaciones'" (click)="activeTab = 'simulaciones'" href="javascript:void(0)">
          <i class="bi bi-calculator-fill"></i> Simulaciones
        </a>
      </li>
    </ul>

    <!-- Tab: Mi Perfil -->
    <div *ngIf="activeTab === 'perfil'" class="tab-content">
      <h3 class="mb-4"><i class="bi bi-person-circle"></i> Mi Perfil de Usuario</h3>
      <div class="card p-4">
        <form [formGroup]="perfilForm" (ngSubmit)="actualizarPerfil()">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre de Usuario</label>
              <input type="text" class="form-control" formControlName="username" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" formControlName="email">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre Completo</label>
              <input type="text" class="form-control" formControlName="nombre">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Apellidos</label>
              <input type="text" class="form-control" formControlName="apellidos">
            </div>
          </div>
          <hr class="my-4">
          <h5>Cambiar Contraseña</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nueva Contraseña</label>
              <input type="password" class="form-control" formControlName="newPassword" autocomplete="new-password">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Confirmar Nueva Contraseña</label>
              <input type="password" class="form-control" formControlName="confirmPassword" autocomplete="new-password">
            </div>
          </div>
          <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
          <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
          <button type="submit" class="btn btn-primary" [disabled]="perfilForm.invalid">Actualizar Perfil</button>
        </form>
      </div>
    </div>

    <!-- Tab: Clientes -->
    <div *ngIf="activeTab === 'clientes'" class="card mb-4">
      <div class="card-header bg-primary text-white"><h4><i class="bi bi-people-fill"></i> Gestión de Clientes</h4></div>
      <div class="card-body">
        <button class="btn btn-success mb-3" (click)="toggleNuevoClienteForm()">
          <i class="bi bi-person-plus-fill"></i> {{ showNuevoClienteForm ? 'Ocultar Formulario' : 'Registrar Nuevo Cliente' }}
        </button>
        <div *ngIf="showNuevoClienteForm" class="card bg-light p-3 mb-4">
          <h5>Datos del Nuevo Cliente</h5>
          <form [formGroup]="clienteForm" (ngSubmit)="onSaveCliente()">
            <div class="row mb-3"><div class="col-md-6"><label for="nombre" class="form-label">Nombre Completo</label><input type="text" id="nombre" class="form-control" formControlName="nombre"></div><div class="col-md-6"><label for="dni" class="form-label">DNI</label><input type="text" id="dni" class="form-control" formControlName="dni"></div></div>
            <div class="row mb-3"><div class="col-md-6"><label for="correo" class="form-label">Correo Electrónico</label><input type="email" id="correo" class="form-control" formControlName="correo"></div><div class="col-md-6"><label for="ocupacion" class="form-label">Ocupación</label><input type="text" id="ocupacion" class="form-control" formControlName="ocupacion"></div></div>
            <div class="row mb-3"><div class="col-md-6"><label for="ingresoMensual" class="form-label">Ingreso Mensual (S/)</label><input type="number" id="ingresoMensual" class="form-control" formControlName="ingresoMensual"></div><div class="col-md-6"><label for="gastoMensual" class="form-label">Gasto Mensual (S/)</label><input type="number" id="gastoMensual" class="form-control" formControlName="gastoMensual"></div></div>
            <button type="submit" class="btn btn-primary" [disabled]="clienteForm.invalid">Guardar Cliente</button>
          </form>
        </div>
        <h5>Clientes Registrados</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Nombre</th><th>DNI</th><th>Correo</th><th>Ocupación</th><th>Ingresos</th></tr></thead>
            <tbody>
            <tr *ngFor="let cliente of clientes" (click)="onSelectCliente(cliente)" [class.table-primary]="cliente === selectedCliente" style="cursor: pointer;">
              <td>{{ cliente.nombre }}</td><td>{{ cliente.dni }}</td><td>{{ cliente.correo }}</td><td>{{ cliente.ocupacion }}</td><td>{{ cliente.ingresoMensual | currency:'S/ ' }}</td>
            </tr>
            <tr *ngIf="!clientes || clientes.length === 0"><td colspan="5" class="text-center text-muted">No hay clientes registrados.</td></tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="selectedCliente" class="alert alert-success mt-3"><i class="bi bi-check-circle-fill"></i> Cliente seleccionado: <strong>{{ selectedCliente.nombre }}</strong></div>
      </div>
    </div>

    <!-- Tab: Unidades -->
    <div *ngIf="activeTab === 'unidades'" class="card mb-4">
      <div class="card-header bg-success text-white"><h4><i class="bi bi-building"></i> Gestión de Unidades Inmobiliarias</h4></div>
      <div class="card-body">
        <button class="btn btn-success mb-3" (click)="toggleNuevaUnidadForm()"><i class="bi bi-house-add-fill"></i> {{ showNuevaUnidadForm ? 'Ocultar Formulario' : 'Registrar Nueva Unidad' }}</button>
        <div *ngIf="showNuevaUnidadForm" class="card bg-light p-3 mb-4">
          <h5>Datos de la Nueva Unidad</h5>
          <form [formGroup]="unidadForm" (ngSubmit)="onSaveUnidad()">
            <div class="row mb-3"><div class="col-md-6"><label class="form-label">Nombre/Código</label><input type="text" class="form-control" formControlName="nombre"></div><div class="col-md-6"><label class="form-label">Dirección</label><input type="text" class="form-control" formControlName="direccion"></div></div>
            <div class="row mb-3"><div class="col-md-4"><label class="form-label">Precio</label><input type="number" class="form-control" formControlName="precio"></div><div class="col-md-4"><label class="form-label">Moneda</label><select class="form-select" formControlName="moneda"><option value="SOLES">Soles (S/)</option><option value="DOLARES">Dólares ($)</option></select></div><div class="col-md-4"><label class="form-label">Estado</label><select class="form-select" formControlName="estadoU"><option [value]="true">Disponible</option><option [value]="false">No Disponible</option></select></div></div>
            <button type="submit" class="btn btn-primary" [disabled]="unidadForm.invalid">Guardar Unidad</button>
          </form>
        </div>
        <h5>Unidades Disponibles</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Código</th><th>Dirección</th><th>Precio</th><th>Estado</th></tr></thead>
            <tbody>
            <tr *ngFor="let unidad of unidades" (click)="onSelectUnidad(unidad)" [class.table-primary]="unidad === selectedUnidad" style="cursor: pointer;">
              <td>{{ unidad.nombre }}</td><td>{{ unidad.direccion }}</td><td>{{ unidad.precio | currency:'S/ ' }}</td>
              <td><span class="badge" [class.bg-success]="unidad.estadoU" [class.bg-secondary]="!unidad.estadoU">{{ unidad.estadoU ? 'Disponible' : 'No Disponible' }}</span></td>
            </tr>
            <tr *ngIf="!unidades || unidades.length === 0"><td colspan="4" class="text-center text-muted">No hay unidades registradas.</td></tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="selectedUnidad" class="alert alert-info mt-3"><i class="bi bi-check-circle-fill"></i> Unidad seleccionada: <strong>{{ selectedUnidad.nombre }}</strong></div>
      </div>
    </div>

    <!-- Tab: Simulaciones -->
    <div *ngIf="activeTab === 'simulaciones'" class="tab-content">
      <h3 class="mb-4"><i class="bi bi-calculator-fill"></i> Crear Simulación de Crédito</h3>
      <div *ngIf="!selectedCliente || !selectedUnidad" class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Atención:</strong> Debes seleccionar un cliente y una unidad inmobiliaria.
        <div class="mt-2">
          <button *ngIf="!selectedCliente" class="btn btn-sm btn-warning me-2" (click)="activeTab = 'clientes'">Seleccionar Cliente</button>
          <button *ngIf="!selectedUnidad" class="btn btn-sm btn-warning" (click)="activeTab = 'unidades'">Seleccionar Unidad</button>
        </div>
      </div>

      <div *ngIf="selectedCliente && selectedUnidad" class="card">
        <div class="card-header bg-primary text-white"><h5>Simulación de Crédito</h5></div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6"><strong>Cliente:</strong> {{ selectedCliente.nombre }}</div>
            <div class="col-md-6"><strong>Unidad:</strong> {{ selectedUnidad.nombre }}</div>
          </div>
          <hr>
          <form [formGroup]="creditoForm" (ngSubmit)="onSaveCredito()">
            <div class="row mb-3">
              <div class="col-12">
                <label class="form-label">Entidad Financiera</label>
                <select class="form-select" formControlName="entidadFinancieraCodigo">
                  <option [ngValue]="null" disabled>-- Seleccione una entidad --</option>
                  <option *ngFor="let entidad of entidades" [value]="entidad.codigo">
                    {{ entidad.nombre }}
                  </option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4"><label class="form-label">Monto del Préstamo ({{ currencyLabel }})</label><input type="number" class="form-control" formControlName="monto"></div>
              <div class="col-md-4"><label class="form-label">Plazo (meses)</label><input type="number" class="form-control" formControlName="plazo"></div>
              <div class="col-md-4"><label class="form-label">Tasa de Interés (%)</label><input type="number" step="0.01" class="form-control" formControlName="tasaInteres"></div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4"><label class="form-label">Tipo de Tasa</label><select class="form-select" formControlName="tipoTasa"><option value="EFECTIVA">Efectiva</option><option value="NOMINAL">Nominal</option></select></div>
              <div class="col-md-4"><label class="form-label">Capitalización</label><select class="form-select" formControlName="capitalizacion"><option value="MENSUAL">Mensual</option><option value="TRIMESTRAL">Trimestral</option><option value="SEMESTRAL">Semestral</option><option value="ANUAL">Anual</option></select></div>
              <div class="col-md-4"><label class="form-label">Moneda</label><select class="form-select" formControlName="moneda"><option value="PEN">Soles (S/)</option><option value="USD">Dólares ($)</option></select></div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Gracia Total (meses)</label>
                <input type="number" class="form-control" formControlName="graciaTotal">
                <div *ngIf="creditoForm.get('graciaTotal')?.invalid && creditoForm.get('graciaTotal')?.touched" class="text-danger mt-1">
                  <small *ngIf="creditoForm.get('graciaTotal')?.errors?.['max']">
                    El máximo para {{ selectedEntidad?.nombre }} es {{ selectedEntidad?.graciaTotalMaxima }} meses.
                  </small>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Gracia Parcial (meses)</label>
                <input type="number" class="form-control" formControlName="graciaParcial">
                <div *ngIf="creditoForm.get('graciaParcial')?.invalid && creditoForm.get('graciaParcial')?.touched" class="text-danger mt-1">
                  <small *ngIf="creditoForm.get('graciaParcial')?.errors?.['max']">
                    El máximo para {{ selectedEntidad?.nombre }} es {{ selectedEntidad?.graciaParcialMaxima }} meses.
                  </small>
                </div>
              </div>
            </div>

            <div *ngIf="selectedCliente" class="mb-3">
              <div *ngIf="clienteEsElegibleParaBono" class="form-check form-switch p-3 rounded" style="background-color: #e0f2f1;">
                <input class="form-check-input" type="checkbox" role="switch" id="bonoSwitch" formControlName="aplicarBonoTechoPropio">
                <label class="form-check-label fw-bold text-success" for="bonoSwitch">
                  <i class="bi bi-patch-check-fill"></i> Aplicar Bono Techo Propio (S/ 43,312.50)
                </label>
                <small class="d-block text-muted">El cliente cumple con el requisito de ingresos.</small>
              </div>
              <div *ngIf="!clienteEsElegibleParaBono" class="alert alert-secondary py-2">
                <i class="bi bi-x-circle"></i> El cliente no es elegible para el Bono Techo Propio (ingreso mensual de {{selectedCliente.ingresoMensual | currency:'S/'}} excede el límite).
              </div>
            </div>

            <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
            <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg" [disabled]="creditoForm.invalid || isSimulating">
                <span *ngIf="isSimulating" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <i *ngIf="!isSimulating" class="bi bi-calculator"></i>
                {{ isSimulating ? 'Generando Simulación...' : 'Generar Simulación (VAN, TIR, TCEA)' }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- SECCIÓN DE RESULTADOS DE LA SIMULACIÓN -->
      <div *ngIf="indicadores && planDePagos.length > 0" class="mt-5">
        <h4 class="mb-3">Resultados de la Simulación para Crédito #{{ savedCredito?.idCredito }}</h4>

        <div *ngIf="bonoAplicadoInfo && bonoAplicadoInfo.aplicado" class="alert alert-success d-flex align-items-center">
          <i class="bi bi-gift-fill fs-4 me-3"></i>
          <div>
            <h5 class="alert-heading">¡Bono Techo Propio Aplicado!</h5>
            Se ha reducido el monto a financiar en <strong>{{ bonoAplicadoInfo.monto | currency:'S/':'symbol':'1.2-2' }}</strong>.
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header bg-success text-white"><h5><i class="bi bi-graph-up"></i> Indicadores Financieros</h5></div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-4"><h6 class="text-muted">TCEA</h6><p class="h4">{{ indicadores.tcea | number:'1.2-2' }}%</p></div>
              <div class="col-md-4"><h6 class="text-muted">VAN</h6><p class="h4">{{ indicadores.van | currency:currencySymbol:'symbol':'1.2-2' }}</p></div>
              <div class="col-md-4"><h6 class="text-muted">TIR</h6><p class="h4">{{ indicadores.tir | number:'1.2-2' }}%</p></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h5><i class="bi bi-table"></i> Plan de Pagos</h5></div>
          <div class="card-body table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
              <tr><th># Cuota</th><th>Saldo Inicial</th><th>Interés</th><th>Amortización</th><th>Cuota</th><th>Saldo Final</th></tr>
              </thead>
              <tbody>
              <tr *ngFor="let pago of planDePagos">
                <td>{{ pago.numeroCuota }}</td>
                <td>{{ pago.saldoInicial | currency:currencySymbol:'symbol':'1.2-2' }}</td>
                <td>{{ pago.interes | currency:currencySymbol:'symbol':'1.2-2' }}</td>
                <td>{{ pago.amortizacion | currency:currencySymbol:'symbol':'1.2-2' }}</td>
                <td class="fw-bold">{{ pago.cuota | currency:currencySymbol:'symbol':'1.2-2' }}</td>
                <td>{{ pago.saldoFinal | currency:currencySymbol:'symbol':'1.2-2' }}</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
